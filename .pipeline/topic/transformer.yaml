version: v4
base: docker-registry.wikimedia.org/python3-buster:0.0.1-20220123
runs:
  insecurely: true

lives:
  in: /srv/topic-transformer

variants:
  build:
    python:
      version: python3
      requirements: [transformer/requirements.txt]
    apt:
      packages:
        - python3-pip
        - python3-dev
        - python-dev
        - build-essential
        - python3-enchant
        - g++
        - gfortran
        - git
        - liblapack-dev
        - libopenblas-dev
        - libenchant1c2a
    builder:
      command: [./build.sh]
      requirements:
        - from: local
          source: transformer/build.sh
          destination: build.sh
        - from: local
          source: transformer/setup.py
          destination: .

  production:
    copies:
      - from: local
        source: transformer/topic_transformer
        destination: topic_transformer
      - from: local
        source: transformer/setup.py
        destination: .
      - from: build
        source: /opt/lib/python/site-packages
        destination: /opt/lib/python/site-packages
    python:
      version: python3
      use-system-flag: false
    apt:
      packages:
        - python3
        - build-essential
        - liblapack3
        - libopenblas-base
        - libenchant1c2a
        - aspell-ar
        - aspell-bn
        - aspell-el
        - hunspell-id
        - hunspell-en-us
        - aspell-is
        - aspell-pl
        - aspell-ro
        - aspell-sv
        - aspell-ta
        - aspell-uk
        - myspell-cs
        - myspell-de-at
        - myspell-de-ch
        - myspell-de-de
        - myspell-es
        - myspell-et
        - myspell-fa
        - myspell-fr
        - myspell-he
        - myspell-hr
        - myspell-hu
        - myspell-lv
        - myspell-nb
        - myspell-nl
        - myspell-pt-pt
        - myspell-pt-br
        - myspell-ru
        - myspell-hr
        - hunspell-bs
        - hunspell-ca
        - hunspell-en-au
        - hunspell-en-us
        - hunspell-en-gb
        - hunspell-eu
        - hunspell-gl
        - hunspell-it
        - hunspell-hi
        - hunspell-sr
        - hunspell-vi
        - voikko-fi
        - wget
        - wmf-certificates
    entrypoint: ["python3",  "-m", "topic_transformer"]
    builder:
      command: [./topic-prerequisites.sh]
      requirements:
        - from: local
          source: model-server/topic-prerequisites.sh
          destination: topic-prerequisites.sh
  test:
    apt:
      packages:
        - python3-pip
        - python3-setuptools
    copies:
      - from: local
        source: transformer
        destination: transformer
    entrypoint: ["tox", "-c", "transformer/tox.ini"]
    python:
      version: python3
      requirements: [transformer/requirements-test.txt]
      use-system-flag: false
