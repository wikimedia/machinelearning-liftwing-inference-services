# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.15.0
version: v4
base: docker-registry.wikimedia.org/buster:20220724
runs:
  insecurely: true

lives:
  in: /srv/outlink-topic-transformer

variants:
  build:
    python:
      version: python3
      requirements: [outlink-topic-model/transformer/requirements.txt]
    apt:
      packages:
        - python3-pip
        - python3-dev
        - build-essential
    builder:
      # FIXME: path hack - see: https://phabricator.wikimedia.org/T267685
      command: ["PYTHONPATH=/opt/lib/python/site-packages", "python3",
        "-m", "pip", "install", "--target",
        "/opt/lib/python/site-packages","."]
      requirements:
        - from: local
          source: outlink-topic-model/transformer/setup.py
          destination: .

  production:
    copies:
      - from: local
        source: outlink-topic-model/transformer/outlink_transformer
        destination: outlink_transformer
      - from: local
        source: outlink-topic-model/transformer/setup.py
        destination: .
      - from: local
        source: python/*.py
        destination: ./
      - from: build
        source: /opt/lib/python/site-packages
        destination: /opt/lib/python/site-packages
    apt:
      packages:
        - python3
        - wmf-certificates
    python:
      version: python3
      use-system-flag: false
    entrypoint: ["python3",  "-m", "outlink_transformer"]

  test:
    apt:
      packages:
        - python3-pip
        - python3-setuptools
    copies:
      - from: local
        source: outlink-topic-model/transformer
        destination: transformer
    entrypoint: ["tox", "-c", "transformer/tox.ini"]
    python:
      version: python3
      requirements: [outlink-topic-model/transformer/requirements.txt, outlink-topic-model/transformer/requirements-test.txt]
      use-system-flag: false
