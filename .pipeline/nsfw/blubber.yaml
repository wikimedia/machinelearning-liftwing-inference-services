version: v4
base: docker-registry.wikimedia.org/buster:20220807
runs:
  insecurely: true

lives:
  in: /srv/nsfw-model

variants:
  build:
    python:
      version: python3
      requirements: [nsfw-model/model-server/requirements.txt]
    apt:
      packages:
        - python3-pip
    builder:
      command: ["rm -rf /var/cache/apk/*"]
  production:
    copies:
      - from: local
        source: nsfw-model/model-server
        destination: model-server
      - from: build
        source: /opt/lib/python/site-packages
        destination: /opt/lib/python/site-packages
    apt:
      packages:
        - python3
        - python3-distutils
    python:
      version: python3
      use-system-flag: false
    entrypoint: ["python3",  "model-server/model.py"]

  test:
    apt:
      packages:
        - python3-pip
    copies:
      - from: local
        source: nsfw-model/model-server
        destination: model-server
    entrypoint: ["tox", "-c", "model-server/tox.ini"]
    python:
      version: python3
      use-system-flag: false
      requirements: [nsfw-model/model-server/requirements-test.txt]
