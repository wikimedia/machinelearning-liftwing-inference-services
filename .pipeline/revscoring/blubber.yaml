# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.24.0
version: v4
base: docker-registry.wikimedia.org/bookworm:20250824
runs:
  insecurely: true
  environment:
    PYTHONPATH: /srv/revscoring:/srv/revscoring/python3.10

lives:
  in: /srv/revscoring

variants:
  build:
    apt:
      packages:
        - build-essential
        - zlib1g-dev
        - libncurses5-dev
        - libgdbm-dev
        - libnss3-dev
        - libssl-dev
        - libreadline-dev
        - libffi-dev
        - libsqlite3-dev
        - wget
        - curl
        - libbz2-dev
        - pkg-config
        - python3-dev
        - libxml2-dev
        - libxslt-dev
        - wmf-certificates
    builders:
    builders:
      - custom:
          # install python3.10 as revscoring does not support python3.11 which is the default in bookworm
          command: [ "./revscoring_model/install_python310.sh" ]
          requirements: [ "revscoring_model/requirements.txt", "revscoring_model/install_python310.sh" ]
      - custom:
          # download word embedding vectors
          command: [ "./revscoring_model/get_embeddings.sh" ]
          requirements: [ "revscoring_model/get_embeddings.sh" ]

  production:
    copies:
      - from: build
        source: /srv/revscoring
        destination: /srv/revscoring
      - from: build
        source: /home/somebody/nltk_data
        destination: /home/somebody/nltk_data
      - from: local
        source: revscoring_model
        destination: revscoring_model
      - from: local
        source: python
        destination: python
    apt:
      packages:
        - python3
        - python3-distutils
        - build-essential
        - liblapack3
        - libopenblas0-pthread
        - libenchant-2-2
        - hunspell-ar
        - aspell-bn
        - aspell-el
        - hunspell-id
        - hunspell-en-us
        - aspell-is
        - aspell-pl
        - aspell-ro
        - aspell-sv
        - aspell-ta
        - aspell-uk
        - hunspell-cs
        - hunspell-de-at
        - hunspell-de-ch
        - hunspell-de-de
        - hunspell-es
        - hunspell-et
        - myspell-fa
        - hunspell-fr
        - hunspell-he
        - hunspell-hr
        - myspell-hu
        - hunspell-lv
        - myspell-nb
        - hunspell-nl
        - hunspell-pt-pt
        - hunspell-pt-br
        - hunspell-ru
        - hunspell-hr
        - hunspell-bs
        - hunspell-ca
        - hunspell-en-au
        - hunspell-en-us
        - hunspell-en-gb
        - hunspell-eu
        - hunspell-gl
        - hunspell-it
        - hunspell-hi
        - hunspell-sr
        - hunspell-vi
        - voikko-fi
        - wmf-certificates
    entrypoint: [ "/srv/revscoring/python3.10/bin/python3.10", "revscoring_model/model.py" ]
